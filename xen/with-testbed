#!/bin/bash
set -e

trap 'exit 127' 0

. ${ADT_XENLVM_SHARE:=/usr/share/autopkgtest/xenlvm}/readconfig
${ADT_XENLVM_SHARE}/cleanup

modprobe dm-snapshot ||:

bdsize=$(blockdev --getsize $adt_lvm_baselv)
dmsetup create $adt_devmapper_cowdev <<END
0 $bdsize snapshot $adt_lvm_baselv $lvm_cowdata_namepath n $adt_fs_cowchunk
END

mkdir -p $lvm_fslink_dirpath
ln -s $lvm_snapdev $lvm_fslink_ptr

xm restore $adt_play/xen-save
xm mem-set $adt_xmname $adt_testbed_ram
udevsettle

set +e
"$@"
rc=$?
set -e

xm destroy $adt_xmname
dmsetup remove $adt_devmapper_cowdev

trap '' 0
exit $rc
